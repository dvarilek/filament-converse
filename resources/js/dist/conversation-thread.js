function C({key:h,conversationKey:d,statePath:o,autoScrollOnForeignMessagesThreshold:c,shouldDispatchUserTypingEvent:u,userTypingIndicatorTimeout:p,userTypingEventDispatchThreshold:m,fileAttachmentAcceptedFileTypes:r,fileAttachmentMaxSize:l,maxFileAttachments:g,fileAttachmentsAcceptedFileTypesValidationMessage:f,fileAttachmentsMaxSizeValidationMessage:v,maxFileAttachmentsValidationMessage:U,$wire:n}){return{messagesCreatedDuringConversationSession:n.entangle("messagesCreatedDuringConversationSession"),typingUsersMap:new Map,typingUserTimeouts:new Map,lastUserTypingEventSentAt:null,isLoadingMoreMessages:!1,isDraggingFileAttachment:!1,uploadingFileAttachments:[],fileAttachmentUploadValidationMessage:null,init(){console.log("reinitialized"),window.Echo.private("filament-converse.conversation."+d).listen(".user.typing",e=>{let t=e.user.id;this.typingUsersMap.set(t,e.user.name),this.typingUserTimeouts.has(t)&&clearTimeout(this.typingUserTimeouts.get(t));let s=setTimeout(()=>{this.typingUsersMap.delete(t),this.typingUserTimeouts.delete(t)},p);this.typingUserTimeouts.set(t,s)}).listen(".message.sent",e=>n.call("registerMessageCreatedDuringConversationSession",e.message.id,e.message.authorId)).listen(".message.deleted",e=>n.call("registerMessageCreatedDuringConversationSession",e.message.id,e.message.authorId,!1)).listen(".message.updated",e=>n.refresh()),this.$watch("messagesCreatedDuringConversationSession",(e,t)=>{let s=a=>!a.createdByAuthenticatedUser&&a.exists,i=a=>a.createdByAuthenticatedUser&&a.exists,A=Object.values(e).filter(s).length,T=Object.values(t).filter(s).length,y=Object.values(e).filter(i).length,M=Object.values(t).filter(i).length;A>T&&this.isPositionedNearBottom()&&this.$nextTick(()=>this.scrollToBottom({behaviour:"smooth"})),y>M&&this.$nextTick(()=>this.scrollToBottom({behaviour:"smooth"}))}),this.registerFileAttachmentUploadEventListeners()},areOtherUsersTyping(){return this.typingUsersMap.size>0},clearConversationThread(){this.typingUsersMap=new Map,this.typingUserTimeouts.forEach(e=>clearTimeout(e)),this.lastUserTypingEventSentAt=null,this.uploadingFileAttachments=[],this.fileAttachmentUploadValidationMessage=[]},scrollToBottom(e){this.$refs.conversationThreadContentEndMarker.scrollIntoView(e)},async fireUserTypingEvent(e){let t=e.target.value;if(!t||t.trim()===""||!u)return;let s=Date.now();this.lastUserTypingEventSentAt&&s-this.lastUserTypingEventSentAt<m||(this.lastUserTypingEventSentAt=s,await n.callSchemaComponentMethod(h,"broadcastUserTypingEvent"))},async loadMoreMessages(){let e=this.$refs.conversationThreadContent,t=e.scrollHeight;this.isLoadingMoreMessages=!0;try{await n.call("incrementActiveConversationMessagesPage")}finally{this.isLoadingMoreMessages=!1,e.scrollTop+=e.scrollHeight-t}},isPositionedNearBottom(){let e=this.$refs.conversationThreadContent;return e.scrollHeight-e.scrollTop-e.clientHeight<(c??0)},isUploadingFileAttachment(){return this.uploadingFileAttachments.length>0},registerFileAttachmentUploadEventListeners(){new Set(["dragenter","dragover","dragleave","drop"]).forEach(e=>this.$el.addEventListener(e,t=>{t.preventDefault(),t.stopPropagation()},!1)),new Set(["dragenter","dragover"]).forEach(e=>{this.$el.addEventListener(e,()=>{this.isDraggingFileAttachment=!0},!1)}),this.$el.addEventListener("dragleave",e=>{this.$el.contains(e.relatedTarget)||(this.isDraggingFileAttachment=!1)}),this.$el.addEventListener("drop",async e=>{this.isDraggingFileAttachment=!1,await this.handleAttachmentUpload(e.dataTransfer&&e.dataTransfer.files||[])})},async handleAttachmentUpload(e){if(!e.length)return;this.fileAttachmentUploadValidationMessage=null;let t=null;if(g&&Array.from(await n.get("componentFileAttachments."+o)||[]).length+e.length>g){this.fileAttachmentUploadValidationMessage=U;return}let s=Array.from(e).filter(i=>r&&!r.includes(i.type)?(t=f,!1):l&&i.size>+l*1024?(t=v,!1):!0);t&&(this.fileAttachmentUploadValidationMessage=t),s.length!==0&&(this.uploadingFileAttachments.push(...s),await n.uploadMultiple("componentFileAttachments."+o,s,()=>this.uploadingFileAttachments=[],()=>this.uploadingFileAttachments=[]))}}}export{C as conversationThread};
